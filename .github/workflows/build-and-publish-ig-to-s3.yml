name: Build & Publish IG to S3

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: read
  id-token: write

concurrency:
  group: build-and-publish-ig-to-s3
  cancel-in-progress: false

env:
  IMAGE_TAG: latest
  IG_DIR: TASMC
  PACKAGE_JSON: package.json
  SUSHI_CONFIG: sushi-config.yaml
  PUBLICATION_REQUEST: publication-request.json
  VERSIONS_MD: input/pagecontent/versions.md

jobs:
  build-and-publish-ig-to-s3:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Resolve image name (lowercase owner)
      # ------------------------------------------------------------
      - name: Set image name
        run: |
          OWNER_LC=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=ghcr.io/${OWNER_LC}/ig-builder" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ============================================================
      # üõë PRE-BUILD VALIDATIONS (GUARDS)
      # ============================================================

      # ------------------------------------------------------------
      # Validate required IG files exist (HARD FAIL)
      # ------------------------------------------------------------
      - name: Validate required IG files exist
        run: |
          for f in "$PACKAGE_JSON" "$SUSHI_CONFIG" "$PUBLICATION_REQUEST"; do
            if [ ! -f "$IG_DIR/$f" ]; then
              echo "‚ùå Missing $IG_DIR/$f"
              exit 1
            fi
          done
          
          echo "‚úÖ required IG files are exists"

      # ------------------------------------------------------------
      # Validate IG versions consistency (HARD FAIL)
      # ------------------------------------------------------------
      - name: Validate IG versions consistency
        run: |
          VERSION_PKG=$(jq -r '.version' "$IG_DIR/$PACKAGE_JSON")
          VERSION_SUSHI=$(grep '^version:' "$IG_DIR/$SUSHI_CONFIG" | awk '{print $2}')
          VERSION_PUB=$(jq -r '.version' "$IG_DIR/$PUBLICATION_REQUEST")

          echo "VERSION=${VERSION_PKG}"         >> $GITHUB_ENV
          echo "VERSION_PKG=${VERSION_PKG}"     >> $GITHUB_ENV
          echo "VERSION_SUSHI=${VERSION_SUSHI}" >> $GITHUB_ENV
          echo "VERSION_PUB=${VERSION_PUB}"     >> $GITHUB_ENV
          
          if [ "$VERSION_PKG" != "$VERSION_SUSHI" ] || [ "$VERSION_PKG" != "$VERSION_PUB" ]; then
            echo "‚ùå Version mismatch"
            echo "package.json:             $VERSION_PKG"
            echo "sushi-config.yaml:        $VERSION_SUSHI"
            echo "publication-request.json: $VERSION_PUB"
            exit 1
          fi
          
          echo "‚úÖ IG versions are consistent"

      # ------------------------------------------------------------
      # Validate FHIR versions consistency (HARD FAIL)
      # ------------------------------------------------------------
      - name: Validate FHIR versions consistency
        run: |
          FHIR_PKG=$(jq -r '.fhirVersions[0]' "$IG_DIR/$PACKAGE_JSON")
          FHIR_SUSHI=$(grep '^fhirVersion:' "$IG_DIR/$SUSHI_CONFIG" | awk '{print $2}')
          FHIR_PUB=$(jq -r '.fhirversion' "$IG_DIR/$PUBLICATION_REQUEST")

          echo "FHIR=${FHIR_PKG}"         >> $GITHUB_ENV
          echo "FHIR_PKG=${FHIR_PKG}"     >> $GITHUB_ENV
          echo "FHIR_SUSHI=${FHIR_SUSHI}" >> $GITHUB_ENV
          echo "FHIR_PUB=${FHIR_PUB}"     >> $GITHUB_ENV
          
          if [ "$FHIR_PKG" != "$FHIR_SUSHI" ] || [ "$FHIR_PKG" != "$FHIR_PUB" ]; then
            echo "‚ùå FHIR version mismatch"
            echo "package.json:             $FHIR_PKG"
            echo "sushi-config.yaml:        $FHIR_SUSHI"
            echo "publication-request.json: $FHIR_PUB"
            exit 1
          fi
          
          echo "‚úÖ FHIR versions are consistent"

      # ------------------------------------------------------------
      # Canonical vs publication path (HARD FAIL)
      # ------------------------------------------------------------
      - name: Validate canonical vs path
        run: |
          CANONICAL=$(grep '^canonical:' "$IG_DIR/$SUSHI_CONFIG" | awk '{print $2}')
          PATH_PUB=$(jq -r '.path' "$IG_DIR/$PUBLICATION_REQUEST")

          case "$PATH_PUB" in
            "$CANONICAL"/*)
              echo "‚úî Publication path is under canonical"
              ;;
            *)
              echo "‚ùå publication path is NOT under canonical"
              echo "canonical: $CANONICAL"
              echo "path:      $PATH_PUB"
              exit 1
              ;;
          esac
          
          echo "‚úÖ canonical path included in the published"

      # ------------------------------------------------------------
      # Validate versions.md mentions built version (HARD FAIL)
      # ------------------------------------------------------------
      - name: Validate versions.md contains built version
        run: |
          VERSIONS_FILE="$IG_DIR/$VERSIONS_MD"

          if [ ! -f "$VERSIONS_FILE" ]; then
            echo "‚ùå Missing $VERSIONS_FILE"
            exit 1
          fi

          if ! grep -Eq "^\|\s*$VERSION\s*\|" "$VERSIONS_FILE"; then
            echo "‚ùå Version $VERSION not found in Version column of versions.md"
            exit 1
          fi

          echo "‚úÖ versions.md contains version $VERSION"

      # ------------------------------------------------------------
      # Configure AWS credentials
      # ------------------------------------------------------------
      - name: Configure AWS credentials (static keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION }}

      # ------------------------------------------------------------
      # Prevent version overwrite (HARD FAIL)
      # ------------------------------------------------------------
      - name: Ensure version not already published
        run: |
          aws s3 ls "s3://${{ secrets.S3_BUCKET }}/$VERSION" && {
            echo "‚ùå Version $VERSION already exists in S3"
            exit 1
          } || true
          
          echo "‚úÖ version is not yet published"

      # ============================================================
      # üß± BUILD
      # ============================================================

      # ------------------------------------------------------------
      # Login to GHCR
      # ------------------------------------------------------------
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------------------------
      # Pull IG Builder image
      # ------------------------------------------------------------
      - name: Pull IG Builder image
        run: docker pull $IMAGE_NAME:$IMAGE_TAG

      # ------------------------------------------------------------
      # Clean output (standalone build)
      # ------------------------------------------------------------
      - name: Clean IG output
        run: |
          rm -rf "$IG_DIR/output"
          mkdir -p "$IG_DIR/output"

      # ------------------------------------------------------------
      # Build IG
      # ------------------------------------------------------------
      - name: Build FHIR Implementation Guide
        run: |
          docker run --rm -v "$PWD:/work" $IMAGE_NAME:$IMAGE_TAG -ig "$IG_DIR"

      # ============================================================
      # üöÄ DEPLOY
      # ============================================================

      # ------------------------------------------------------------
      # Deploy versioned IG
      # ------------------------------------------------------------
      - name: Deploy versioned IG
        run: |
          aws s3 sync "$IG_DIR/output/" "s3://${{ secrets.S3_BUCKET }}/$VERSION" --delete

      # ------------------------------------------------------------
      # Deploy current IG
      # ------------------------------------------------------------
      - name: Deploy current IG
        run: |
          aws s3 sync "$IG_DIR/output/" "s3://${{ secrets.S3_BUCKET }}/current" --delete

      # ------------------------------------------------------------
      # Purge Cloudflare cache per host only
      # ------------------------------------------------------------
      - name: Purge Cloudflare cache (only for host ${{ vars.CF_HOST }})
        run: |
          echo "Purging Cloudflare cache for host: ${{ vars.CF_HOST }}"
          curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data "{
              \"hosts\": [\"${{ vars.CF_HOST }}\"]
            }"
